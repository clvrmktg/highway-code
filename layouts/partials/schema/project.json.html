{{/* ==== Collect fields from front matter ==== */}}
{{- $title := .Title -}}
{{- $desc  := (.Description | default .Summary | default $title) | markdownify | plainify | chomp -}}
{{- $prop  := .Params.proposition_heading | default "" -}}
{{- $sub   := .Params.subhead | default "" -}}

{{- $industries   := .Params.industries   | default (slice) -}}
{{- $deliverables := .Params.deliverables | default (slice) -}}

{{- $clientName := .Params.client | default "" -}}
{{- $clientURL  := .Params.project_link | default "" -}}

{{- $datePublished := .Date.Format "2006-01-02T15:04:05Z07:00" -}}
{{- $dateModified  := (.Lastmod | default .Date).Format "2006-01-02T15:04:05Z07:00" -}}

{{/* Choose best image (share > screen > thumb) */}}
{{- $img := "" -}}
{{- with .Params.share.path  }}{{ $img = (print $.Site.BaseURL .) }}{{ end -}}
{{- if eq $img "" }}{{ with .Params.screen.path }}{{ $img = (print $.Site.BaseURL .) }}{{ end }}{{ end -}}
{{- if eq $img "" }}{{ with .Params.thumb.path  }}{{ $img = (print $.Site.BaseURL .) }}{{ end }}{{ end -}}

{{/* Build keywords from industries + deliverables (as a single string) */}}
{{- $keywords := slice -}}
{{- range $industries   }}{{ $keywords = $keywords | append . }}{{ end -}}
{{- range $deliverables }}{{ $keywords = $keywords | append . }}{{ end -}}
{{- $keywordsStr := delimit $keywords ", " -}}

{{/* IDs for linking entities */}}
{{- $webpageID := print .Permalink "#webpage" -}}
{{- $workID    := print .Permalink "#case-study" -}}
{{- $siteID    := print .Site.BaseURL "#website" -}}
{{- $bizID     := print .Site.BaseURL "#localbusiness" -}}

{{/* ---------- WebPage schema ---------- */}}
{{- $web := dict
  "@context" "https://schema.org"
  "@type"    "WebPage"
  "@id"      $webpageID
  "url"      .Permalink
  "name"     $title
  "description" $desc
  "isPartOf"   (dict "@id" $siteID)
  "breadcrumb" (dict "@id" (print .Permalink "#breadcrumbs"))
  "datePublished" $datePublished
  "dateModified"  $dateModified
  "mainEntity"    (dict "@id" $workID)
-}}

{{- if $img -}}
  {{- $web = merge $web (dict "primaryImageOfPage" (dict "@type" "ImageObject" "url" $img)) -}}
{{- end -}}

<!-- WebPage Schema -->
<script type="application/ld+json">{{ $web | jsonify (dict "indent" "  ") }}</script>

{{/* ---------- CreativeWork (Case Study) ---------- */}}
{{- $name := cond (ne $prop "") (print $prop " â€” " $title) $title -}}
{{- $headline := cond (ne $prop "") $prop $title -}}

{{- $work := dict
  "@context" "https://schema.org"
  "@type"    "CreativeWork"
  "@id"      $workID
  "name"     $name
  "headline" $headline
  "alternativeHeadline" $sub
  "description" $desc
  "url"       .Permalink
  "inLanguage" "en"
  "genre"     "Case Study"
  "keywords"  $keywordsStr
  "datePublished" $datePublished
  "dateModified"  $dateModified
  "creator"  (dict "@id" $bizID)
  "provider" (dict "@id" $bizID)
-}}

{{- if $img -}}
  {{- $work = merge $work (dict "image" $img) -}}
{{- end -}}

{{- if or $clientName $clientURL -}}
  {{- $recipient := dict "@type" "Organization" -}}
  {{- if $clientName }}{{ $recipient = merge $recipient (dict "name" $clientName) }}{{ end -}}
  {{- if $clientURL  }}{{ $recipient = merge $recipient (dict "url"  $clientURL)  }}{{ end -}}
  {{- $work = merge $work (dict "recipient" $recipient) -}}
{{- end -}}

{{- if gt (len $industries) 0 -}}
  {{- $about := slice -}}
  {{- range $industries -}}
    {{- $about = $about | append (dict "@type" "Thing" "name" (. | markdownify | plainify | chomp)) -}}
  {{- end -}}
  {{- $work = merge $work (dict "about" $about) -}}
{{- end -}}

{{- if gt (len $deliverables) 0 -}}
  {{- $mentions := slice -}}
  {{- range $deliverables -}}
    {{- $mentions = $mentions | append (dict "@type" "Service" "name" (. | markdownify | plainify | chomp)) -}}
  {{- end -}}
  {{- $work = merge $work (dict "mentions" $mentions) -}}
{{- end -}}

<!-- CreativeWork (Case Study) Schema -->
<script type="application/ld+json">{{ $work | jsonify (dict "indent" "  ") }}</script>