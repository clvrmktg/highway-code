{{- /* Sidebar: root + its children always visible; expand only active child; only exact page is current */ -}}
{{- $p := .Page -}}
{{- $root := $p.Site.GetPage (printf "/%s" $p.Section) -}}
{{- if not $root }}{{ if and $p.IsSection (ne $p.Section "") }}{{ $root = $p }}{{ end }}{{ end }}

{{- define "render-icon" -}}
  {{- $name := . -}}
  {{- if $name -}}
    {{- $path := printf "static/icons/tabler/%s.svg" $name -}}
    {{- if fileExists $path -}}
      <span class="[ icon-wrap ][ flex middle ]" aria-hidden="true">{{ readFile $path | safeHTML }}</span>
    {{- end -}}
  {{- end -}}
{{- end -}}

<nav class="[ sidebar__navigation ][ p--1 r--5 ]"
     aria-label="{{ if $root }}{{ $root.Title }}{{ else }}Section{{ end }}">
  <ul class="[ sidebar__navigation__menu ][ grid row-gap--0.5 ]" role="list">
    {{- if $root -}}
      {{- /* Root link */ -}}
      {{- $isRootCurrent := eq $root.Permalink $p.Permalink -}}
      <li class="[ sidebar__navigation__item ]" role="listitem">
        <a class="[ sidebar__navigation__link ][ flex middle col-gap--0.5 px--0.5 py--0.25 r--5 {{ if $isRootCurrent }}current{{ end }} ]"
           href="{{ $root.RelPermalink }}"
           {{ if $isRootCurrent }}aria-current="page"{{ end }}
           data-prefetch>
          {{ template "render-icon" $root.Params.icon }}
          <span class="label">{{ $root.Title }}</span>
        </a>
      </li>

      {{- /* Root\'s direct children (always visible) */ -}}
      {{- $children := where (union $root.Sections $root.RegularPages) "Params.draft" "ne" true -}}
      {{- range $child := $children.ByWeight -}}
        {{- $isChildCurrent := eq $child.Permalink $p.Permalink -}}
        {{- $isAncestor := hasPrefix $p.RelPermalink $child.RelPermalink -}}
        {{- $isOpen := and (not $isChildCurrent) $isAncestor -}} {{/* open when ancestor but not current */}}

        <li class="[ sidebar__navigation__item {{ if $isOpen }}open{{ end }} ]"
            role="listitem"
            aria-expanded="{{ if $isOpen }}true{{ else }}false{{ end }}">
          <a class="[ sidebar__navigation__link ][ flex middle col-gap--0.5 px--0.5 py--0.25 r--5 {{ if $isChildCurrent }}current{{ end }} ]"
             href="{{ $child.RelPermalink }}"
             {{ if $isChildCurrent }}aria-current="page"{{ end }}
             data-prefetch>
            {{ template "render-icon" $child.Params.icon }}
            <span class="label">{{ $child.Title }}</span>
          </a>

          {{- /* Only expand grandchildren for the open (ancestor) child OR when the child itself is the current page */ -}}
          {{- if and $child.IsSection (or $isOpen $isChildCurrent) -}}
            {{- $grand := where (union $child.Sections $child.RegularPages) "Params.draft" "ne" true -}}
            {{- if gt (len $grand) 0 -}}
              <ul class="[ sidebar__navigation__submenu ][ pt--0.5 ]" role="list">
                {{- range $g := $grand.ByWeight -}}
                  {{- $isGrandCurrent := eq $g.Permalink $p.Permalink -}}
                  <li class="[ sidebar__navigation__subitem ][ pl--2 ]" role="listitem">
                    <a class="[ sidebar__navigation__sublink ][ flex middle col-gap--0.5 px--0.5 py--0.25 r--5 {{ if $isGrandCurrent }}current{{ end }} ]"
                       href="{{ $g.RelPermalink }}"
                       {{ if $isGrandCurrent }}aria-current="page"{{ end }}
                       data-prefetch>
                      {{ template "render-icon" $g.Params.icon }}
                      <span class="label">{{ $g.Title }}</span>
                    </a>
                  </li>
                {{- end -}}
              </ul>
            {{- end -}}
          {{- end -}}
        </li>
      {{- end -}}
    {{- end -}}
  </ul>
</nav>
